# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "mouse_matrix_v9.h5"
extracted_expression_file = "CD4 T cell_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/mouse_matrix_v9.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1921173","GSM1921166","GSM1921170","GSM1921168","GSM1921171","GSM1921172","GSM2056369","GSM2056368","GSM1921167","GSM1921169","GSM2048403","GSM1903918","GSM2048396","GSM2048399","GSM2056371","GSM2048401","GSM2048405","GSM2048395","GSM2048397","GSM2048406","GSM2048400","GSM2048404","GSM2048398","GSM2048402","GSM2056370","GSM1903915","GSM2560194","GSM2560197","GSM2560195","GSM2560199","GSM2560198",
"GSM2560196","GSM1694174","GSM1694175","GSM1694176","GSM1694177","GSM2817068","GSM2817069","GSM2842928","GSM2842929","GSM2842930","GSM2842931","GSM2842932","GSM2842933","GSM2842934","GSM2842935","GSM2842936","GSM2842937","GSM2842938","GSM2842939","GSM2842940","GSM2842941","GSM2842942","GSM2842943","GSM2842944","GSM2842945","GSM2842863","GSM2842865","GSM2842870","GSM2842871","GSM2842872",
"GSM2842876","GSM2842877","GSM2842878","GSM2842882","GSM2842883","GSM2842884","GSM2842888","GSM2842889","GSM2842890","GSM2842894","GSM2842895","GSM2842896","GSM2842900","GSM2842901","GSM2842902","GSM2842906","GSM2842907","GSM2842908","GSM2842912","GSM2842913","GSM2842916","GSM2842917","GSM2842918","GSM2842922","GSM2842923","GSM2842924","GSM2981759","GSM2981760","GSM2981761","GSM2981762",
"GSM2981763","GSM2981764","GSM2863703","GSM2863704","GSM2863705","GSM2863706","GSM3140236","GSM3140237","GSM3140238","GSM3140239","GSM2478105","GSM2478106","GSM2693617","GSM2693618","GSM2693619","GSM2693620","GSM2693621","GSM2693622","GSM2693623","GSM2693624","GSM2693625","GSM1903919","GSM1903920","GSM1903921","GSM1903922","GSM2639659","GSM2639660","GSM2639661","GSM2639662","GSM2790851",
"GSM2790852","GSM2790853","GSM2790854","GSM2790855","GSM2790856","GSM2790857","GSM2790858","GSM2790859","GSM2790860","GSM2790861","GSM2790862","GSM3272753","GSM3272754","GSM3272755","GSM3272756","GSM3272757","GSM3272758","GSM3272759","GSM3272760","GSM3272761","GSM3272762","GSM3229647","GSM3229648","GSM3229649","GSM3229650","GSM3229651","GSM3229652","GSM3239543","GSM3239544","GSM3239545",
"GSM3239546","GSM3239547","GSM3239548","GSM3239549","GSM3239550","GSM3239551","GSM3188434","GSM3188435","GSM3243677","GSM3243678","GSM3243679","GSM3243680","GSM3243681","GSM3243682","GSM3243683","GSM3243684","GSM3243685","GSM3243686","GSM3446273","GSM3446274","GSM3446275","GSM3446276","GSM3068143","GSM3068144","GSM3068145","GSM3068146","GSM3068147","GSM3068148","GSM3068149","GSM3068150",
"GSM3068151","GSM3068152","GSM3068153","GSM3068154","GSM3068155","GSM3068156","GSM3068157","GSM3068158","GSM3068159","GSM3068160","GSM3068161","GSM3068162","GSM3068163","GSM3068164","GSM3068165","GSM3068166","GSM3068167","GSM3068168","GSM3068169","GSM3068170","GSM3068171","GSM3068172","GSM3068173","GSM3068174","GSM3068175","GSM3068176","GSM3068177","GSM3068178","GSM3068179","GSM3068180",
"GSM3068181","GSM3068182","GSM3068183","GSM3068184","GSM3068185","GSM3068186","GSM3068187","GSM3068188","GSM3068189","GSM3068190","GSM3068191","GSM3068192","GSM3068193","GSM3068194","GSM3068195","GSM3068196","GSM3068197","GSM3068198","GSM3262714","GSM2464942","GSM2464943","GSM2464944","GSM2464945","GSM2464946","GSM2464947","GSM2464948","GSM2464949","GSM2464950","GSM2464951","GSM2464952",
"GSM2464953","GSM2464954","GSM2464955","GSM2464956","GSM2464957","GSM2464958","GSM2464959","GSM2464960","GSM2464961","GSM2464962","GSM2464963","GSM2464964","GSM2464965","GSM3536221","GSM3536222","GSM3536223","GSM3536224","GSM3536225","GSM3536226","GSM3711887","GSM3711888","GSM3711889","GSM3738769","GSM3738773","GSM3738775","GSM3738776","GSM3538849","GSM3538850","GSM3538851","GSM3538852",
"GSM3538853","GSM3538854","GSM4043995","GSM4043996","GSM4043997","GSM4043998","GSM4043999","GSM4044000","GSM4132542","GSM4132543","GSM4132544","GSM4132545","GSM4132546","GSM4132547","GSM4132548","GSM4132549","GSM4132550","GSM4132551","GSM4132552","GSM4132553","GSM3421723","GSM3421724","GSM3421725","GSM3421726","GSM3421727","GSM3178482","GSM3178483","GSM3440856","GSM3440857","GSM3440858",
"GSM3440859","GSM3440861","GSM3440862","GSM3440863","GSM3440864","GSM3440865","GSM3703403","GSM3703404","GSM3703405","GSM3703406","GSM3703407","GSM3703408","GSM3703409","GSM3703410","GSM3703411","GSM3703412","GSM3703413","GSM3703414","GSM3703415","GSM3703416","GSM3703417","GSM3703418","GSM3703419","GSM3703420","GSM3703421","GSM3703422","GSM3703423","GSM3703424","GSM3703425","GSM3703426",
"GSM3703427","GSM3703428","GSM3703429","GSM3703430","GSM3942187","GSM3942188","GSM3942189","GSM3942190","GSM3942191","GSM3942192","GSM3942193","GSM4067287","GSM4067288","GSM4067289","GSM4067290","GSM4067291","GSM4067292","GSM4067293","GSM4067294","GSM4067295","GSM4067296","GSM4067297","GSM4067298","GSM4067299","GSM4067300","GSM4067301","GSM4067302","GSM4067303","GSM4067304","GSM4067305",
"GSM4067306","GSM4067307","GSM4067308","GSM4067309","GSM4067310","GSM4067311","GSM4067312","GSM4067313","GSM4067314","GSM4067315","GSM4067316","GSM4067317","GSM4067318","GSM4067319","GSM4067320","GSM4067321","GSM4067322","GSM4067323","GSM4067324","GSM4067325","GSM4067326","GSM4067327","GSM4067328","GSM4067329","GSM4067330","GSM4067331","GSM4067332","GSM4067333","GSM4067334","GSM4067335",
"GSM4196432","GSM4196433","GSM4196434","GSM4196435","GSM4196436","GSM4196437","GSM4196849","GSM4196850","GSM4196851","GSM4196852","GSM4196853","GSM4196854","GSM4422953","GSM4422954","GSM4422955","GSM4422956","GSM4422957","GSM4422958","GSM4422959","GSM4422960","GSM4422961","GSM4422963","GSM4422964","GSM4422965","GSM4422966","GSM4422967","GSM4422968","GSM4422969","GSM4422970","GSM4423576",
"GSM4423577","GSM4423578","GSM4423579","GSM4423580","GSM4423581","GSM4423582","GSM4423583","GSM4423584","GSM4423585","GSM4423586","GSM4423587","GSM4489553","GSM4489554","GSM4489555","GSM4489556","GSM4489557","GSM4489558","GSM4489559","GSM4489560","GSM4489561","GSM4489562","GSM4489563","GSM4489564","GSM4489565","GSM4489566","GSM4489567","GSM4489568","GSM4577866","GSM4577867","GSM4577869",
"GSM4577870","GSM4577871","GSM4577873","GSM4577874","GSM4577875","GSM4577877","GSM4588344","GSM4588345","GSM4588346","GSM4588347","GSM4588348","GSM4588349","GSM4588350","GSM4588351","GSM4630550","GSM4630551","GSM4630552","GSM4630554","GSM4630555","GSM4630556","GSM4630557","GSM4630558","GSM4630559","GSM4630560","GSM4630562","GSM4630563","GSM4630564","GSM4630565","GSM4630566","GSM4630567",
"GSM4630568","GSM4630569","GSM4630570","GSM4630571","GSM4630572","GSM4630573","GSM4630574","GSM4630575","GSM4630576","GSM4630577","GSM4630578","GSM4630579","GSM4630580","GSM4630581","GSM4630582","GSM4630583","GSM4630584","GSM4630585","GSM4630586","GSM4630587","GSM4630588","GSM4630589","GSM4630591","GSM4630592","GSM4630593","GSM4630594","GSM4630595","GSM4630596","GSM4630597","GSM4630598",
"GSM4630599","GSM4630600","GSM4630601","GSM4630602","GSM4630603","GSM4630604","GSM4630605","GSM4630606","GSM4630608","GSM4630609","GSM4630610","GSM4630611","GSM4630612","GSM4630613","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

